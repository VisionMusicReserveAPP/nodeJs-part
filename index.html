<!DOCTYPE html>
<html>
<head>
  <style>
  *{ margin: 0px; padding: 0 px;}
  div {
    margin: 10px;
    padding: 10px;
    border: 3px solid black;
    border-radius: 10px;
  }

  </style>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script type = "text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script>
<script>

var find_title = '';
var request_2 = ''; // request를 한번에 받을수 있도록 함
var except_tag = '';
var seperate_result = '';
var save_data = new Array(lastdate);

var today = '';
var month = '';
var lastdate = '';
var xmlData = ''; // xml로 데이터를 저장

var go_function = ''; // 저장을 하기위한 매개 변수

function writefile(go_function){

  try
  {
    var opener = new ActiveXObject("Scripting.FileSystemObject");
    var file = opener.OpenTextFile('C:\\node\\public\\test1.txt',2,true);

    file.WriteLine(go_function);

    file.Close();
  } catch (e){
    if(e.number == -2146827859){
      alert('저장이 안됩니다. 오류를 수정해 주세요!');
    }
  }


}



function creatRequest(){
  var request;

  try{
    request = new XMLHttpRequest();
  }catch(exception){
    try{
      request = new ActiveXObject('Msxml2.XMLHTTP');
    } catch(innerException) {
      request = new ActiveXObject('Microsoft.XMLHTTP');
    }
  }

  return request;
}

function accept_request(){ // request를 한번에 해주는 함수

  request_2 = creatRequest();
  request_2.open('GET','http://localhost:8080/hello/NewFile.jsp',false);
  //Ajax를 수행
  request_2.send();

}

function find_title_Request(){ //예약 페이지의 제목을 찾아주는 역할

  accept_request(); // 로컬 호스트에 올려져있는 페이지를 요청

  //출력합니다
  var find_title_1 = request_2.responseText.search("비전합주실"); //7월 합주실 예약
  var find_title_2 = request_2.responseText.search("일정상황"); //7월 합주실 예약
  var find_title_result = request_2.responseText.slice(find_title_1,find_title_2-2);

  find_title = find_title_result;
  //alert(find_title);
}


function find_vision_band(){

 accept_request();

 var temp_total = '';//임시로 받아 놓을 수 있는 변수
 var temp_search = ''; //
 var temp_search2 = '';
 var temp_slice = '' ;
 var temp_sub = '' // while문을 도와줌

 //전체적으로 한번 자르기
 temp_total = request_2.responseText; // 임시 변수에 값을 넣음
 temp_search =  temp_total.lastIndexOf('2411BA4D574ECBC831E925');//+3
 temp_search2 = temp_total.search("</table>");
 temp_total = temp_total.slice(temp_search+24, temp_search2);

 temp_sub = temp_total.lastIndexOf("<");
 temp_search = temp_total.search("<");


 for(var i = 0;i<10000;i++){
 temp_search = temp_total.search("<");
 temp_search2 = temp_total.indexOf(">",temp_search);
 temp_slice = temp_total.slice(temp_search,temp_search2+1);

 temp_total = temp_total.replace(temp_slice, '');
}

 temp_total = temp_total.replace('>', '');
 temp_total = temp_total.replace('&nbsp;', '');

 to_date();

 var logic_num = '-';
 var change_num = lastdate;
 var temp_count = 0;


 while(temp_count != lastdate ){ //기준이 되는 compare_slice 와 temp_count를 비교

 temp_search = temp_total.search(change_num + logic_num); // 30-
 temp_search2 = temp_total.indexOf(change_num-1 + logic_num, temp_search);
 temp_slice = temp_total.slice(temp_search,temp_search2);

 save_data[temp_count] = temp_slice;

 temp_count++;
 change_num--;
 }

load_data();
  //room을 기준으로 나눠짐 먼저 A룸부터 C룸까지 데이터를 순차적으로 검색

}

function load_data(){

var temp_total = '';
var temp_search = ''; //
var temp_search2 = '';
var temp_slice = '' ;
var temp_sub = ''; // 요일을 비교할 내용
var temp_count = ''; // 요일 숫자


var week = ['월','화','수','목','금','토','일'];
var day_decision = '';

var day_search = 13;
var logic_num = ']';

temp_sub = save_data[day_search].search(logic_num);
temp_search = save_data[day_search].slice(temp_sub-1,temp_sub);

//요일을 알아내는 로직
for(var i=0;i<7; i++){
  if(week[i] == temp_search){
    day_decision = week[i]; // 월요일인 것이 결정됨 월요일 이외의 것들을 지워야함
    temp_count = i;
    week.splice(i,1);
  }
}

/* 날짜 공백이 생기는 곳은 다른 날의 데이터까지 불러오게 됨. 그것을 방지하기 위한 반복문.
  하지만 마지막에 다듬는 작업이 필요함.  */
for(var i = 0; i<6;i++){
  if(save_data[4].search(week[i]) != '' ){
    temp_search = save_data[day_search].indexOf(week[i] + logic_num, day_decision + logic_num);//차기요일
    temp_search2 = save_data[day_search].lastIndexOf(logic_num);
    temp_slice = save_data[day_search].slice(temp_search,temp_search2);
    save_data[day_search] = save_data[day_search].replace(temp_slice,'');
  }
  else{
  return true;
  }

}
document.body.innerHTML = save_data[day_search];
//먼저 오픈시간과 A,B,C 룸을 나눔

//오픈 시간을 알아내는 코드

temp_search = save_data[day_search].search(']');
temp_search2 = save_data[day_search].indexOf('room',temp_search);
temp_slice = save_data[day_search].slice(temp_search,temp_search2);


temp_search = temp_slice.search(']');
temp_search2 = temp_slice.lastIndexOf('-');
temp_slice = temp_slice.slice(temp_search,temp_search2);
alert(temp_slice);

if(temp_slice == ''){
  alert('문여는 시간이 정해지지 않았습니다.');
}

// alert(temp_slice);


temp_search = save_data[day_search].search('최대인원 제한 예약');
temp_search2 = save_data[day_search].search('7인수용');
temp_sub = save_data[day_search].search('5인');
//alert(temp_search);
if(temp_search == -1 ){

  alert('A룸 예약이 없음');//

  if(temp_search2 != -1){

    alert('B룸 예약이 존재');

    temp_search = save_data[day_search].search('7인수용');
    temp_search2 = save_data[day_search].indexOf('room',temp_search);

    if(temp_search2 == -1){ // c룸 예약이 없을경우
       alert('B룸은 있지만 c룸 예약이 없음');
       temp_search2 = save_data[day_search].lastIndexOf(']');
       temp_slice = save_data[day_search].slice(temp_search+9,temp_search2);
       alert(temp_slice);
    }

    if(temp_sub != -1){
      alert('C룸 예약이 존재');
    }
  }

} else if(temp_search2 == -1 ){
  alert('B룸 예약이 없음');
} else if(temp_sub == -1){
  alert('C룸 예약이 없음');
}
else{
  alert('모든 방 예약이 존재');
}
/*
고정 부분 바뀌지 않는다
A룸 - 최대인원 제한 예약 존재
B룸 - 7인 수용
c룸 - 5인

*/




//var xmlData += '<?xml version='+"1.0"+' encoding='+'UTF-8'+'?>';



//go_function = save_data[day_search];//저장을 하기전 매개변수에다 저장

//writefile(go_function);



}
//액티브 x랑 xml파일 만드는거, 방별로 나누는 작업





function to_date(){
   today = new Date();
   month = today.getMonth();

   if(month == 2){
     lastdate = 28; //윤년 일 경우는 29
   }
   else if (month == 4 || month == 6 || month == 9 || month == 11 ) {
     lastdate = 30;
   }
   else{
     lastdate = 31;
   }
}

function rental_reservation(){
//비전 합주실 렌탈 예약
  accept_request();

  var temp_total = '';//임시로 받아 놓을 수 있는 변수
  var temp_search = ''; //
  var temp_search2 = '';
  var temp_slice = '' ;
  var temp_sub = '' // while문을 도와줌



  //전체적으로 한번 잘라냄
  temp_total = request_2.responseText; // 임시 변수에 값을 넣음
  temp_search = temp_total.search("비전합주실 렌탈대여");
  //alert(temp_search);
  temp_search2 = temp_total.indexOf("<a href=",temp_search);
  //alert(temp_search2);
  temp_slice = temp_total.slice(temp_search,temp_search2+1);
  //alert(temp_slice);

  //세부적으로 나눔
  temp_total = temp_slice;
  temp_sub = temp_total.lastIndexOf("<");
  //alert(temp_sub);

  //태그문자 제거
for(var i = 0; i<100;i++){
  temp_search = temp_total.search("<");
  temp_search2 = temp_total.indexOf(">",temp_search);
  temp_slice = temp_total.slice(temp_search,temp_search2+1);

  temp_total = temp_total.replace(temp_slice, '');
}

temp_total = temp_total.replace('<','');
temp_total = temp_total.replace('&nbsp;','');

alert(temp_total); //문자열만 남음

// 2] 1]순서 찾기 로직 만들기
var logic_num = ']';
var change_num = 1;
//따로 내용을 저장할 배열 지정
temp_search = temp_total.search(change_num + logic_num); // 1]
temp_search2 = temp_total.lastIndexOf(']');

temp_compare = temp_total.search(']') + 1; // 아래서부터 위로 번호가 올라가는 형식 ] 앞에 있는 번수를 파악
temp_compare_slice = temp_total.slice(temp_compare-3,temp_compare-1); //두자리 수 일 가능성을 고려
temp_compare_slice = temp_compare_slice.replace('&nbsp;','');

alert(temp_compare_slice);

var temp_count = 0;

while(temp_count != temp_compare_slice ){ //기준이 되는 compare_slice 와 temp_count를 비교

temp_search = temp_total.search(change_num + logic_num); // 1]
temp_search2 = temp_total.lastIndexOf(']');
temp_slice = temp_total.slice(temp_search,temp_search2+1); // 첫번째 장비 대여 항목 저장
//alert(temp_slice); //1]을 포함한 문자열
temp_total = temp_total.replace(temp_slice, '');
alert(temp_total);
temp_slice = temp_slice.replace(change_num + logic_num, '');
alert(temp_slice); // 1]을 지운 문자열 이 문자열을 배열로 저장하기

temp_count++;
change_num++;

}
}







$(document).ready(function(){
  //find_title_Request();
  find_vision_band();
  //rental_reservation(); //비전 렌탈 예약
});
</script>
</head>
<body>

</body>
</html>
